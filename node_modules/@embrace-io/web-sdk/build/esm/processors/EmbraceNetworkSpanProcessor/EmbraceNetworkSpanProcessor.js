import { ATTR_URL_FULL, SEMATTRS_HTTP_URL, ATTR_HTTP_RESPONSE_STATUS_CODE, SEMATTRS_HTTP_STATUS_CODE, ATTR_HTTP_REQUEST_METHOD, SEMATTRS_HTTP_METHOD, SEMATTRS_HTTP_RESPONSE_CONTENT_LENGTH, SEMATTRS_HTTP_REQUEST_CONTENT_LENGTH } from '@opentelemetry/semantic-conventions';
import { ATTR_HTTP_RESPONSE_BODY_SIZE, ATTR_HTTP_REQUEST_BODY_SIZE } from '@opentelemetry/semantic-conventions/incubating';
import { isNetworkSpan } from './types.js';
import { EMB_TYPES, KEY_EMB_TYPE } from '../../constants/attributes.js';

/**
 * Embrace's API expects network spans to have some specific attributes.
 * This processor checks if a span is a network span and adds them.
 */ class EmbraceNetworkSpanProcessor {
    forceFlush() {
        return Promise.resolve(undefined);
    }
    // TODO `onEnd` is not supposed to modify the span. There is a new experimental onEnding api that allows modifying
    //  the span before it is sent to the exporter. This processor should be updated to use that api once that is available
    onEnd(span) {
        if (isNetworkSpan(span)) {
            span.attributes[KEY_EMB_TYPE] = EMB_TYPES.Network;
            /*
        Fallback on deprecated attribute names in case the span is using those instead of the latest ones

        The current versions of @opentelemetry/instrumentation-xml-http-request and @opentelemetry/instrumentation-fetch
        that we're getting from @opentelemetry/auto-instrumentations-web are using these, once we update we'll remove
        this fallback and only support a single version of the semantic convention
       */ // eslint-disable-next-line @typescript-eslint/no-deprecated
            span.attributes[ATTR_URL_FULL] ??= span.attributes[SEMATTRS_HTTP_URL];
            span.attributes[ATTR_HTTP_RESPONSE_STATUS_CODE] ??= span.attributes[SEMATTRS_HTTP_STATUS_CODE];
            span.attributes[ATTR_HTTP_REQUEST_METHOD] ??= span.attributes[SEMATTRS_HTTP_METHOD];
            span.attributes[ATTR_HTTP_RESPONSE_BODY_SIZE] ??= span.attributes[SEMATTRS_HTTP_RESPONSE_CONTENT_LENGTH];
            span.attributes[ATTR_HTTP_REQUEST_BODY_SIZE] ??= span.attributes[SEMATTRS_HTTP_REQUEST_CONTENT_LENGTH];
        }
    }
    onStart() {
    // do nothing.
    }
    shutdown() {
        return Promise.resolve(undefined);
    }
}

export { EmbraceNetworkSpanProcessor };
//# sourceMappingURL=EmbraceNetworkSpanProcessor.js.map
