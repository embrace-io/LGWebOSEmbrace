{"version":3,"file":"withEmbraceRouting.js","sources":["../../../../../../../src/instrumentations/navigation/NavigationInstrumentation/react/reactRouterV6Declarative/withEmbraceRouting.ts"],"sourcesContent":["import type { RoutesFunctionalComponentReturn } from './types.js';\nimport React from 'react';\nimport hoistNonReactStatics from 'hoist-non-react-statics';\nimport { getNavigationInstrumentation } from '../../index.js';\nimport type { Route } from '../../index.js';\nimport { EMB_NAVIGATION_INSTRUMENTATIONS } from '../../../../../constants/index.js';\n\n// Routes can be nested, we need to traverse the routeContext to find the last route\nconst getLastRoute = (\n  matchedComponent: RoutesFunctionalComponentReturn,\n  lastRoute: Route | null\n): Route | null => {\n  if (!matchedComponent.props.match || !matchedComponent.props.match.route) {\n    return null;\n  }\n\n  const path = lastRoute\n    ? `${lastRoute.path}/${matchedComponent.props.match.route.path}`\n    : matchedComponent.props.match.route.path;\n\n  if (matchedComponent.props.routeContext?.outlet) {\n    return getLastRoute(matchedComponent.props.routeContext.outlet, {\n      path,\n      url: matchedComponent.props.match.pathname,\n    });\n  }\n\n  return {\n    path,\n    url: matchedComponent.props.match.pathname,\n  };\n};\n\nexport const withEmbraceRouting = <P extends object>(\n  WrappedComponent: React.FunctionComponent<P>\n) => {\n  const navigationInstrumentation = getNavigationInstrumentation();\n  navigationInstrumentation.setInstrumentationType(\n    EMB_NAVIGATION_INSTRUMENTATIONS.Declarative\n  );\n\n  const RoutesWithEmbraceRouting: React.FC<P> = (props: P) => {\n    /**\n     * React-router v6+ implementation is very different from v5\n     * It doesn't have a <Switch> component that injects props into <Route>\n     * Instead, it has <Routes> which internally calculates the matched route\n     * and returns it as a children, <Route> cannot be wrapped since it requires all children to be a <Route> component\n     * here we rely on that matching to get the current route.\n     * It's not ideal to rely on internal implementation details, but it's the easier way of getting the current route\n     * without having to manually match it or using hooks on each children component\n     *\n     * See: https://github.com/remix-run/react-router/blob/main/packages/react-router/lib/hooks.tsx#L553\n     */\n    const matchedComponent = WrappedComponent(\n      props\n    ) as unknown as RoutesFunctionalComponentReturn;\n\n    if (matchedComponent.props.match && matchedComponent.props.match.route) {\n      const lastRoute = getLastRoute(matchedComponent, null);\n      if (lastRoute) {\n        navigationInstrumentation.setCurrentRoute(lastRoute);\n      }\n    }\n\n    return React.createElement<P>(WrappedComponent, props);\n  };\n\n  // Keep wrapped component metadata\n  RoutesWithEmbraceRouting.displayName = `withEmbraceRouting(${WrappedComponent.displayName || WrappedComponent.name || 'Component'})`;\n  hoistNonReactStatics(RoutesWithEmbraceRouting, WrappedComponent);\n\n  return RoutesWithEmbraceRouting;\n};\n"],"names":["getLastRoute","matchedComponent","lastRoute","props","match","route","path","routeContext","outlet","url","pathname","withEmbraceRouting","WrappedComponent","navigationInstrumentation","getNavigationInstrumentation","setInstrumentationType","EMB_NAVIGATION_INSTRUMENTATIONS","Declarative","RoutesWithEmbraceRouting","setCurrentRoute","React","createElement","displayName","name","hoistNonReactStatics"],"mappings":";;;;;AAOA;AACA,MAAMA,YAAAA,GAAe,CACnBC,gBAAAA,EACAC,SAAAA,GAAAA;AAEA,IAAA,IAAI,CAACD,gBAAAA,CAAiBE,KAAK,CAACC,KAAK,IAAI,CAACH,gBAAAA,CAAiBE,KAAK,CAACC,KAAK,CAACC,KAAK,EAAE;QACxE,OAAO,IAAA;AACT,IAAA;IAEA,MAAMC,IAAAA,GAAOJ,SAAAA,GACT,CAAA,EAAGA,SAAAA,CAAUI,IAAI,CAAC,CAAC,EAAEL,gBAAAA,CAAiBE,KAAK,CAACC,KAAK,CAACC,KAAK,CAACC,IAAI,CAAA,CAAE,GAC9DL,gBAAAA,CAAiBE,KAAK,CAACC,KAAK,CAACC,KAAK,CAACC,IAAI;AAE3C,IAAA,IAAIL,gBAAAA,CAAiBE,KAAK,CAACI,YAAY,EAAEC,MAAAA,EAAQ;AAC/C,QAAA,OAAOR,aAAaC,gBAAAA,CAAiBE,KAAK,CAACI,YAAY,CAACC,MAAM,EAAE;AAC9DF,YAAAA,IAAAA;AACAG,YAAAA,GAAAA,EAAKR,gBAAAA,CAAiBE,KAAK,CAACC,KAAK,CAACM;AACpC,SAAA,CAAA;AACF,IAAA;IAEA,OAAO;AACLJ,QAAAA,IAAAA;AACAG,QAAAA,GAAAA,EAAKR,gBAAAA,CAAiBE,KAAK,CAACC,KAAK,CAACM;AACpC,KAAA;AACF,CAAA;AAEO,MAAMC,qBAAqB,CAChCC,gBAAAA,GAAAA;AAEA,IAAA,MAAMC,yBAAAA,GAA4BC,4BAAAA,EAAAA;IAClCD,yBAAAA,CAA0BE,sBAAsB,CAC9CC,+BAAAA,CAAgCC,WAAW,CAAA;AAG7C,IAAA,MAAMC,2BAAwC,CAACf,KAAAA,GAAAA;AAC7C;;;;;;;;;;QAWA,MAAMF,mBAAmBW,gBAAAA,CACvBT,KAAAA,CAAAA;QAGF,IAAIF,gBAAAA,CAAiBE,KAAK,CAACC,KAAK,IAAIH,gBAAAA,CAAiBE,KAAK,CAACC,KAAK,CAACC,KAAK,EAAE;YACtE,MAAMH,SAAAA,GAAYF,aAAaC,gBAAAA,EAAkB,IAAA,CAAA;AACjD,YAAA,IAAIC,SAAAA,EAAW;AACbW,gBAAAA,yBAAAA,CAA0BM,eAAe,CAACjB,SAAAA,CAAAA;AAC5C,YAAA;AACF,QAAA;QAEA,OAAOkB,cAAAA,CAAMC,aAAa,CAAIT,gBAAAA,EAAkBT,KAAAA,CAAAA;AAClD,IAAA,CAAA;;AAGAe,IAAAA,wBAAAA,CAAyBI,WAAW,GAAG,CAAC,mBAAmB,EAAEV,gBAAAA,CAAiBU,WAAW,IAAIV,gBAAAA,CAAiBW,IAAI,IAAI,WAAA,CAAY,CAAC,CAAC;AACpIC,IAAAA,oBAAAA,CAAqBN,wBAAAA,EAA0BN,gBAAAA,CAAAA;IAE/C,OAAOM,wBAAAA;AACT;;;;"}