{"version":3,"file":"SpanSessionBrowserActivityInstrumentation.js","sources":["../../../../../src/instrumentations/session/SpanSessionBrowserActivityInstrumentation/SpanSessionBrowserActivityInstrumentation.ts"],"sourcesContent":["import type { TimeoutRef } from '../../../utils/index.js';\nimport {\n  bulkAddEventListener,\n  bulkRemoveEventListener,\n  throttle,\n} from '../../../utils/index.js';\nimport { EmbraceInstrumentationBase } from '../../EmbraceInstrumentationBase/index.js';\nimport {\n  EVENT_THROTTLING_TIME_WINDOW,\n  TIMEOUT_TIME,\n  WINDOW_USER_EVENTS,\n} from './constants.js';\nimport type { SpanSessionBrowserActivityInstrumentationArgs } from './types.js';\n\n/**\n *  SpanSessionBrowserActivityInstrumentation will track the user activity and end the session span if there is no\n *  activity for a certain amount of time.\n *  SpanSessionBrowserActivityInstrumentation will initialize new sessions if new activity is detected and there is no\n *  active session.\n * */\nexport class SpanSessionBrowserActivityInstrumentation extends EmbraceInstrumentationBase {\n  private readonly _onActivityThrottled: () => void;\n  private _activityTimeout: TimeoutRef | null;\n\n  public constructor({\n    diag,\n  }: SpanSessionBrowserActivityInstrumentationArgs = {}) {\n    super({\n      instrumentationName: 'SpanSessionBrowserActivityInstrumentation',\n      instrumentationVersion: '1.0.0',\n      diag,\n      config: {},\n    });\n    this._activityTimeout = null;\n    this._onActivityThrottled = throttle(\n      this._onActivity,\n      EVENT_THROTTLING_TIME_WINDOW\n    );\n    if (this._config.enabled) {\n      this.enable();\n    }\n  }\n\n  public disable = () => {\n    bulkRemoveEventListener({\n      target: window,\n      events: WINDOW_USER_EVENTS,\n      callback: this._onActivityThrottled,\n    });\n    if (this._activityTimeout) {\n      clearTimeout(this._activityTimeout);\n    }\n    this._activityTimeout = null;\n  };\n\n  public enable = () => {\n    bulkAddEventListener({\n      target: window,\n      events: WINDOW_USER_EVENTS,\n      callback: this._onActivityThrottled,\n    });\n  };\n\n  private readonly _onInactivity = () => {\n    this._diag.debug('Inactivity detected');\n    if (this._activityTimeout) {\n      clearTimeout(this._activityTimeout);\n    }\n    this._activityTimeout = null;\n    this.sessionManager.endSessionSpanInternal('inactivity');\n  };\n\n  private readonly _onActivity = () => {\n    this._diag.debug('Activity detected');\n    if (this._activityTimeout) {\n      clearTimeout(this._activityTimeout);\n    }\n    // if there was no active session, start one\n    if (!this.sessionManager.getSessionId()) {\n      this.sessionManager.startSessionSpan({ reason: 'activity' });\n    }\n    this._activityTimeout = setTimeout(this._onInactivity, TIMEOUT_TIME);\n  };\n}\n"],"names":["SpanSessionBrowserActivityInstrumentation","EmbraceInstrumentationBase","diag","instrumentationName","instrumentationVersion","config","disable","bulkRemoveEventListener","target","window","events","WINDOW_USER_EVENTS","callback","_onActivityThrottled","_activityTimeout","clearTimeout","enable","bulkAddEventListener","_onInactivity","_diag","debug","sessionManager","endSessionSpanInternal","_onActivity","getSessionId","startSessionSpan","reason","setTimeout","TIMEOUT_TIME","throttle","EVENT_THROTTLING_TIME_WINDOW","_config","enabled"],"mappings":";;;;;;AAcA;;;;;MAMO,MAAMA,yCAAAA,SAAkDC,0BAAAA,CAAAA;AAI7D,IAAA,WAAA,CAAmB,EACjBC,IAAI,EAC0C,GAAG,EAAE,CAAE;AACrD,QAAA,KAAK,CAAC;YACJC,mBAAAA,EAAqB,2CAAA;YACrBC,sBAAAA,EAAwB,OAAA;AACxBF,YAAAA,IAAAA;AACAG,YAAAA,MAAAA,EAAQ;AACV,SAAA,CAAA,EAAA,IAAA,CAWKC,OAAAA,GAAU,IAAA;YACfC,uBAAAA,CAAwB;gBACtBC,MAAAA,EAAQC,MAAAA;gBACRC,MAAAA,EAAQC,kBAAAA;gBACRC,QAAAA,EAAU,IAAI,CAACC;AACjB,aAAA,CAAA;YACA,IAAI,IAAI,CAACC,gBAAgB,EAAE;gBACzBC,YAAAA,CAAa,IAAI,CAACD,gBAAgB,CAAA;AACpC,YAAA;YACA,IAAI,CAACA,gBAAgB,GAAG,IAAA;AAC1B,QAAA,CAAA,EAAA,IAAA,CAEOE,MAAAA,GAAS,IAAA;YACdC,oBAAAA,CAAqB;gBACnBT,MAAAA,EAAQC,MAAAA;gBACRC,MAAAA,EAAQC,kBAAAA;gBACRC,QAAAA,EAAU,IAAI,CAACC;AACjB,aAAA,CAAA;AACF,QAAA,CAAA,EAAA,IAAA,CAEiBK,aAAAA,GAAgB,IAAA;AAC/B,YAAA,IAAI,CAACC,KAAK,CAACC,KAAK,CAAC,qBAAA,CAAA;YACjB,IAAI,IAAI,CAACN,gBAAgB,EAAE;gBACzBC,YAAAA,CAAa,IAAI,CAACD,gBAAgB,CAAA;AACpC,YAAA;YACA,IAAI,CAACA,gBAAgB,GAAG,IAAA;AACxB,YAAA,IAAI,CAACO,cAAc,CAACC,sBAAsB,CAAC,YAAA,CAAA;AAC7C,QAAA,CAAA,EAAA,IAAA,CAEiBC,WAAAA,GAAc,IAAA;AAC7B,YAAA,IAAI,CAACJ,KAAK,CAACC,KAAK,CAAC,mBAAA,CAAA;YACjB,IAAI,IAAI,CAACN,gBAAgB,EAAE;gBACzBC,YAAAA,CAAa,IAAI,CAACD,gBAAgB,CAAA;AACpC,YAAA;;AAEA,YAAA,IAAI,CAAC,IAAI,CAACO,cAAc,CAACG,YAAY,EAAA,EAAI;AACvC,gBAAA,IAAI,CAACH,cAAc,CAACI,gBAAgB,CAAC;oBAAEC,MAAAA,EAAQ;AAAW,iBAAA,CAAA;AAC5D,YAAA;AACA,YAAA,IAAI,CAACZ,gBAAgB,GAAGa,WAAW,IAAI,CAACT,aAAa,EAAEU,YAAAA,CAAAA;AACzD,QAAA,CAAA;QAjDE,IAAI,CAACd,gBAAgB,GAAG,IAAA;AACxB,QAAA,IAAI,CAACD,oBAAoB,GAAGgB,SAC1B,IAAI,CAACN,WAAW,EAChBO,4BAAAA,CAAAA;AAEF,QAAA,IAAI,IAAI,CAACC,OAAO,CAACC,OAAO,EAAE;AACxB,YAAA,IAAI,CAAChB,MAAM,EAAA;AACb,QAAA;AACF,IAAA;AA0CF;;;;"}