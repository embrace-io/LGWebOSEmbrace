{"version":3,"file":"EmbraceFetchInstrumentation.cjs","sources":["../../../../../src/instrumentations/fetch/EmbraceFetchInstrumentation/EmbraceFetchInstrumentation.ts"],"sourcesContent":["import type { EmbraceFetchInstrumentationArgs } from './types.js';\n\nimport { FetchInstrumentation } from '@opentelemetry/instrumentation-fetch';\nimport { isWrapped } from '@opentelemetry/instrumentation';\n\nexport class EmbraceFetchInstrumentation extends FetchInstrumentation {\n  private readonly _omitIfAlreadyPatched?: boolean;\n\n  public constructor({\n    omitIfAlreadyPatched,\n    ...rest\n  }: EmbraceFetchInstrumentationArgs = {}) {\n    // Base constructor automatically calls this.enable() if enabled is true, but we need to run our overridden constructor\n    // first so force enabled false here and call it ourselves later\n    super({ ...rest, enabled: false });\n\n    this._omitIfAlreadyPatched = omitIfAlreadyPatched;\n\n    if (rest.enabled) {\n      this.enable();\n    }\n  }\n\n  public override enable(): void {\n    // The base implementation always removes and then re-patches, this means the last instrumentation to run \"wins\":\n    // https://github.com/open-telemetry/opentelemetry-js/blob/2d7eecbb19aec17bf2d8b9a4e4b2d84dc92c2d88/experimental/packages/opentelemetry-instrumentation-fetch/src/fetch.ts#L604\n    // Exposing an option in this class to allow leaving the existing patch in place and letting a previous instrumentation\n    // control the global\n    if (this._omitIfAlreadyPatched && isWrapped(fetch)) {\n      this._diag.debug(\n        'fetch is already passed and `omitIfAlreadyPatched` is true, skipping enabling this instrumentation'\n      );\n      return;\n    }\n\n    super.enable();\n  }\n}\n"],"names":["EmbraceFetchInstrumentation","FetchInstrumentation","omitIfAlreadyPatched","rest","enabled","_omitIfAlreadyPatched","enable","isWrapped","fetch","_diag","debug"],"mappings":";;;;;AAKO,MAAMA,2BAAAA,SAAoCC,yCAAAA,CAAAA;IAG/C,WAAA,CAAmB,EACjBC,oBAAoB,EACpB,GAAGC,MAC6B,GAAG,EAAE,CAAE;;;AAGvC,QAAA,KAAK,CAAC;AAAE,YAAA,GAAGA,IAAI;YAAEC,OAAAA,EAAS;AAAM,SAAA,CAAA;QAEhC,IAAI,CAACC,qBAAqB,GAAGH,oBAAAA;QAE7B,IAAIC,IAAAA,CAAKC,OAAO,EAAE;AAChB,YAAA,IAAI,CAACE,MAAM,EAAA;AACb,QAAA;AACF,IAAA;IAEgBA,MAAAA,GAAe;;;;;AAK7B,QAAA,IAAI,IAAI,CAACD,qBAAqB,IAAIE,0BAAUC,KAAAA,CAAAA,EAAQ;AAClD,YAAA,IAAI,CAACC,KAAK,CAACC,KAAK,CACd,oGAAA,CAAA;AAEF,YAAA;AACF,QAAA;AAEA,QAAA,KAAK,CAACJ,MAAAA,EAAAA;AACR,IAAA;AACF;;;;"}